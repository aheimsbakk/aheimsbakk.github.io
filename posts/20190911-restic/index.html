<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Design an online ransomware safe backup with restic | &gt; /dev/null 2&gt;&amp;1</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">    
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta name="description" content="The only way to be safe for ransomware, except for keeping a offline backup, is to have a immutable online backup.
restic is a deduplication backup sofware, designed for ease of use and security. Rclone is a versatile program for syncing data between a huge variety of protocols and cloud providers.">
<meta name="generator" content="Hugo 0.89.4" />


  <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="stylesheet" href="/css/style.css">


  
    
    <link rel="stylesheet" href="https://blog.heimsbakk.net/css/overrides.css">
  


<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />







  </head>

  <body>
    <nav class="navigation">
	
		<a href="/"> <span class="arrow">←</span>Home</a>
	
	<a href="/posts">Archive</a>
	<a href="/tags">Tags</a>
	<a href="/about">About</a>

	

	
	  <a class="button" href="https://blog.heimsbakk.net/index.xml">Subscribe</a>
	
</nav>


    <main class="main">
      

<section id="single">
    <h1 class="title">Design an online ransomware safe backup with restic</h1>

    <div class="tip">
        <time datetime="2019-09-11 00:00:00 &#43;0000 UTC">Sep 11, 2019</time>
        <span class="split">
          ·
        </span>
        <span>
          499 words
        </span>
        <span class="split">
          ·
        </span>
        <span>
          3 minute read
        </span>
    </div>

    
    


    <div class="content">
      <p>The only way to be safe for <a href="https://en.wikipedia.org/wiki/Ransomware" title="Ransomware is a type of malicious software from cryptovirology that threatens to publish the victim&#39;s data or perpetually block access to it unless a ransom is paid."  target="_blank" rel="noopener">ransomware</a>, except for keeping a offline backup, is to have a <a href="https://en.wikipedia.org/wiki/Immutable_object" title="An immutable object is an object whose state cannot be modified after it is created."  target="_blank" rel="noopener">immutable</a> online backup.</p>
<p><a href="https://restic.net" title="Backups done right!"  target="_blank" rel="noopener">restic</a> is a <a href="https://en.wikipedia.org/wiki/Data_deduplication" title="In computing, data deduplication is a specialized data compression technique for eliminating duplicate copies of repeating data. Related and somewhat synonymous terms are intelligent compression and single-instance storage."  target="_blank" rel="noopener">deduplication</a> backup sofware, designed for ease of use and security. <a href="https://rclone.org" title="Rclone - rsync for cloud storage."  target="_blank" rel="noopener">Rclone</a> is a versatile program for syncing data between a huge variety of protocols and cloud providers. What is especially nifty is that <em>restic</em> can use <em>rclone</em> as a backend, and by that extend <em>restic</em> destination into most cloud providers.</p>
<h2 id="problem">Problem <a href="#problem" class="anchor">🔗</a></h2><p>Setting up an automated backup from one macine is no problem. This can be done quite easily with</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">restic -p password_file -r sftp://user@destination/srv/backups init
</code></pre></div><p>Backups is then done with</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">restic -p password_file -r sftp://user@destination/srv/backups backup /srv/backmeup
</code></pre></div><p>If a malicious actor has access to the source machine, they will have read and write access to the backup on the destination. To avoid giving the malicious actor write access to already existing backups, we need to ensure that existing backups on the destination never is changed. This is done by making the destination immutable. When data is written, it cannot be changed later.</p>
<h2 id="solution">Solution <a href="#solution" class="anchor">🔗</a></h2><p>This can be solved in couple of ways</p>
<ol>
<li>Use a immutable backend, in example immutable object storage in the cloud.</li>
<li>Make any destination immutable by relying all traffic through a secured <em>rclone</em> proxy with the <code>--append-only</code> forced.</li>
</ol>
<h2 id="design-rely-traffic-through-proxy">Design, rely traffic through proxy <a href="#design-rely-traffic-through-proxy" class="anchor">🔗</a></h2><div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plain" data-lang="plain">     source               intermediate                destination
+---------------+       +--------------+  chosen     +-----------+
|               |  SSH  | rclone       |  transport  | favorite  |
| /srv/backmeup | ----&gt; | append only  | ----------&gt; | cloud     |
|               |       | rely         |             | storage   |
+---------------+       +--------------+             +-----------+
</code></pre></div><h2 id="configure">Configure <a href="#configure" class="anchor">🔗</a></h2><h3 id="on-source">On <em>source</em> <a href="#on-source" class="anchor">🔗</a></h3><ol>
<li>
<p>Create a SSH key on the <em>source</em> without a password.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ssh-keygen -t ed25519 -f .ssh/id_ed25519 -N <span style="color:#ba2121">&#39;&#39;</span>
</code></pre></div></li>
<li>
<p>Cat the newly created key <code>.ssh/id_ed25519.pub</code></p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plain" data-lang="plain">ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAS2qJU7yIDRVY9cgjyJ0tGM32aB/aaeSwjQ0O/RTN6d
</code></pre></div></li>
</ol>
<h3 id="on-intermediate">On <em>intermediate</em> <a href="#on-intermediate" class="anchor">🔗</a></h3><ol>
<li>
<p>Secure the <em>intermediate</em> server as you see fit. Do <strong>not allow</strong> unrestricted SSH from the <em>source</em>.</p>
</li>
<li>
<p>Log in as your user, in this example <code>user</code>.</p>
</li>
<li>
<p>Create a <em>rclone</em> profile, in this case it&rsquo;s called <em>myprofile</em>.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">rclone config
</code></pre></div></li>
<li>
<p>Test the profile.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">rclone ls myprofile:
</code></pre></div></li>
<li>
<p>Allow <em>source</em> to SSH into <em>intermediate</em> and run a very limited <em>rclone</em> which only may append data to <em>myprofile</em>. Edit <code>.ssh/authorized_keys</code>.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plain" data-lang="plain">restrict,command=&#34;rclone serve restic --stdio --append-only myprofile:backups&#34; ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAS2qJU7yIDRVY9cgjyJ0tGM32aB/aaeSwjQ0O/RTN6d
</code></pre></div></li>
</ol>
<h3 id="back-on-source">Back on <em>source</em> <a href="#back-on-source" class="anchor">🔗</a></h3><ol>
<li>
<p>Create a unique password for the backup. Take note of this password! You will not be able to restore without it.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">apg -m <span style="color:#666">32</span> | head -1 &gt; restic.pwd
chmod <span style="color:#666">400</span> restic.pwd
cat restic.pwd
</code></pre></div></li>
<li>
<p>Initiate <em>restic</em> backup repository.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">restic -o rclone.program<span style="color:#666">=</span><span style="color:#ba2121">&#39;ssh user@intermediate&#39;</span> -p restic.pwd -r rclone: init
</code></pre></div></li>
<li>
<p>Back up your data.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">restic -o rclone.program<span style="color:#666">=</span><span style="color:#ba2121">&#39;ssh user@intermediate&#39;</span> -p restic.pwd -r rclone: backup /srv/backmeup
</code></pre></div></li>
<li>
<p>Create a job that run <em>restic</em> regularly.</p>
</li>
</ol>
<p>You can use all <em>restic</em> commands as normal, except repair and cleanup commands.</p>
<h2 id="conclusion">Conclusion <a href="#conclusion" class="anchor">🔗</a></h2><p>Now you have a <em>source</em> which backs up data online.</p>
<p>If the <em>source</em> get compromised, the malicious actor cannot</p>
<ul>
<li>Delete or change old backups.</li>
<li>Know final destination of backups.</li>
</ul>
<h2 id="caveats">Caveats <a href="#caveats" class="anchor">🔗</a></h2><ul>
<li><em>source</em> should newer have normal SSH into <em>intermediate</em></li>
<li>Access to <em>intermediate</em> should be restricted. 2FA is recommended, example <a href="https://www.yubico.com" target="_blank" rel="noopener">YubiKey</a>.</li>
</ul>

    </div>

    
        <div class="tags">
            
                <a href="https://blog.heimsbakk.net/tags/howto">howto</a>
            
                <a href="https://blog.heimsbakk.net/tags/restic">restic</a>
            
                <a href="https://blog.heimsbakk.net/tags/security">security</a>
            
        </div>
    
    
    

</section>


    </main>
    
    <footer id="footer">
    
        <div id="social">


    <a class="symbol" href="https://github.com/aheimsbakk" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
  <path d="M16 0.396c-8.839 0-16 7.167-16 16 0 7.073 4.584 13.068 10.937 15.183 0.803 0.151 1.093-0.344 1.093-0.772 0-0.38-0.009-1.385-0.015-2.719-4.453 0.964-5.391-2.151-5.391-2.151-0.729-1.844-1.781-2.339-1.781-2.339-1.448-0.989 0.115-0.968 0.115-0.968 1.604 0.109 2.448 1.645 2.448 1.645 1.427 2.448 3.744 1.74 4.661 1.328 0.14-1.031 0.557-1.74 1.011-2.135-3.552-0.401-7.287-1.776-7.287-7.907 0-1.751 0.62-3.177 1.645-4.297-0.177-0.401-0.719-2.031 0.141-4.235 0 0 1.339-0.427 4.4 1.641 1.281-0.355 2.641-0.532 4-0.541 1.36 0.009 2.719 0.187 4 0.541 3.043-2.068 4.381-1.641 4.381-1.641 0.859 2.204 0.317 3.833 0.161 4.235 1.015 1.12 1.635 2.547 1.635 4.297 0 6.145-3.74 7.5-7.296 7.891 0.556 0.479 1.077 1.464 1.077 2.959 0 2.14-0.020 3.864-0.020 4.385 0 0.416 0.28 0.916 1.104 0.755 6.4-2.093 10.979-8.093 10.979-15.156 0-8.833-7.161-16-16-16z"/>
</svg>

    </a>

    <a class="symbol" href="https://www.linkedin.com/in/arnulfheimsbakk" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
  <path d="M27.26 27.271h-4.733v-7.427c0-1.771-0.037-4.047-2.475-4.047-2.468 0-2.844 1.921-2.844 3.916v7.557h-4.739v-15.271h4.552v2.083h0.061c0.636-1.203 2.183-2.468 4.491-2.468 4.801 0 5.692 3.161 5.692 7.271v8.385zM7.115 9.912c-1.527 0-2.751-1.235-2.751-2.756 0-1.516 1.229-2.749 2.751-2.749s2.755 1.233 2.755 2.749c0 1.521-1.233 2.756-2.755 2.756zM9.489 27.271h-4.749v-15.271h4.749zM29.636 0h-27.276c-1.303 0-2.36 1.031-2.36 2.307v27.387c0 1.276 1.057 2.307 2.36 2.307h27.271c1.301 0 2.369-1.031 2.369-2.307v-27.387c0-1.276-1.068-2.307-2.369-2.307z"/>
</svg>

    </a>

    <a class="symbol" href="https://twit.social/@arnulf" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28"  viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" class="bi bi-mastodon">
  <path d="M11.19 12.195c2.016-.24 3.77-1.475 3.99-2.603.348-1.778.32-4.339.32-4.339 0-3.47-2.286-4.488-2.286-4.488C12.062.238 10.083.017 8.027 0h-.05C5.92.017 3.942.238 2.79.765c0 0-2.285 1.017-2.285 4.488l-.002.662c-.004.64-.007 1.35.011 2.091.083 3.394.626 6.74 3.78 7.57 1.454.383 2.703.463 3.709.408 1.823-.1 2.847-.647 2.847-.647l-.06-1.317s-1.303.41-2.767.36c-1.45-.05-2.98-.156-3.215-1.928a3.614 3.614 0 0 1-.033-.496s1.424.346 3.228.428c1.103.05 2.137-.064 3.188-.189zm1.613-2.47H11.13v-4.08c0-.859-.364-1.295-1.091-1.295-.804 0-1.207.517-1.207 1.541v2.233H7.168V5.89c0-1.024-.403-1.541-1.207-1.541-.727 0-1.091.436-1.091 1.296v4.079H3.197V5.522c0-.859.22-1.541.66-2.046.456-.505 1.052-.764 1.793-.764.856 0 1.504.328 1.933.983L8 4.39l.417-.695c.429-.655 1.077-.983 1.934-.983.74 0 1.336.259 1.791.764.442.505.661 1.187.661 2.046v4.203z"/>
</svg>

    </a>

    <a class="symbol" href="https://twitter.com/aheimsbakk" rel="me" target="_blank">
        
        <svg fill="#bbbbbb" width="28" height="28" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
  <path d="M31.937 6.093c-1.177 0.516-2.437 0.871-3.765 1.032 1.355-0.813 2.391-2.099 2.885-3.631-1.271 0.74-2.677 1.276-4.172 1.579-1.192-1.276-2.896-2.079-4.787-2.079-3.625 0-6.563 2.937-6.563 6.557 0 0.521 0.063 1.021 0.172 1.495-5.453-0.255-10.287-2.875-13.52-6.833-0.568 0.964-0.891 2.084-0.891 3.303 0 2.281 1.161 4.281 2.916 5.457-1.073-0.031-2.083-0.328-2.968-0.817v0.079c0 3.181 2.26 5.833 5.26 6.437-0.547 0.145-1.131 0.229-1.724 0.229-0.421 0-0.823-0.041-1.224-0.115 0.844 2.604 3.26 4.5 6.14 4.557-2.239 1.755-5.077 2.801-8.135 2.801-0.521 0-1.041-0.025-1.563-0.088 2.917 1.86 6.36 2.948 10.079 2.948 12.067 0 18.661-9.995 18.661-18.651 0-0.276 0-0.557-0.021-0.839 1.287-0.917 2.401-2.079 3.281-3.396z"/>
</svg>

    </a>


</div>

    

    <div class="copyright">
    
       © Copyright 
       2022 
       <span class="split">
        <svg fill="#bbbbbb" width="15" height="15" version="1.1" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15px" height="15px" viewBox="0 0 15 15">
  <path d="M13.91,6.75c-1.17,2.25-4.3,5.31-6.07,6.94c-0.1903,0.1718-0.4797,0.1718-0.67,0C5.39,12.06,2.26,9,1.09,6.75&#xA;&#x9;C-1.48,1.8,5-1.5,7.5,3.45C10-1.5,16.48,1.8,13.91,6.75z"/>
</svg>
       </span>
       Arnulf Heimsbakk
    
    </div>

    
      <div class="powerby">
        Powered by <a href='http://www.gohugo.io/'>Hugo</a> Theme By <a href='https://github.com/nodejh/hugo-theme-mini'>nodejh</a>
      </div>
    
</footer>



  </body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
          <title>> /dev/null > 2>&1</title>
        <meta charset="utf-8" />
        <link href="http://blog.heimsbakk.net/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="> /dev/null > 2>&1 Full Atom Feed" />
        <link href="http://blog.heimsbakk.net/feeds/blog.atom.xml" type="application/atom+xml" rel="alternate" title="> /dev/null > 2>&1 Categories Atom Feed" />



    <meta name="tags" contents="howto" />
    <meta name="tags" contents="openstack" />
    <meta name="tags" contents="vagrant" />

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://blog.heimsbakk.net/">> /dev/null > 2>&1 <strong></strong></a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li><a href="/index.html">home</a></li>
            <li><a href="#">|</a></li>
              <li class="active"><a href="http://blog.heimsbakk.net/category/blog.html">blog</a></li>
              <li><a href="http://blog.heimsbakk.net/category/uris.html">uris</a></li>
        </ul></nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="http://blog.heimsbakk.net/posts/2014/2014-12-15-vagrant-openstack.html" rel="bookmark"
         title="Permalink to Vagrant with OpenStack">Vagrant with OpenStack</a></h2>
 
  </header>
  <footer class="post-info">
    <abbr class="published" title="2014-12-18T00:00:00">
      to. 18 desember 2014
    </abbr>
    <address class="vcard author">
      By           <a class="url fn" href="http://blog.heimsbakk.net/author/arnulf.html">arnulf</a>
    </address>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <p>If you want to use <a href="https://www.vagrantup.com">Vagrant</a> with <a href="http://www.openstack.org">OpenStack</a>, you need to prepare <a href="https://www.vagrantup.com">Vagrant</a> with installing the <a href="https://github.com/cloudbau/vagrant-openstack-plugin">vagrant-openstack-plugin</a>. I had some problems installing it directly through <code>vagrant plugin install</code>. I had to clone it from <a href="https://github.com">Github</a> and install it manually. </p>
<h2>One time configuration</h2>
<h3>Install OpenStack plugin in Vagrant</h3>
<div class="highlight"><pre><span class="nb">cd</span> /tmp
git clone https://github.com/cloudbau/vagrant-openstack-plugin
<span class="nb">cd </span>vagrant-openstack-plugin
gem build vagrant-openstack-plugin.gemspec
vagrant plugin install vagrant-openstack-plugin-*.gem
</pre></div>


<p>Add a dummy box to <a href="https://www.vagrantup.com">Vagrant</a> thats needed by the plugin.</p>
<div class="highlight"><pre>vagrant box add dummy https://github.com/cloudbau/vagrant-openstack-plugin/raw/master/dummy.box
</pre></div>


<h3>Download OpenStack RC file</h3>
<ul>
<li>Log into OpenStack</li>
<li>Download OpenStack API RC file</li>
<li>Go to <code>Project</code> -&gt; <code>Compute</code> -&gt; <code>Access &amp; Security</code> -&gt; <code>API Access</code> </li>
<li>Down RC file by hitting <code>Download OpenStack RC File</code></li>
<li>Put <code>$USER-openrc.sh</code> in your <code>~/</code> or somewhere you prefer</li>
</ul>
<h2>Configure a Vagrant VM</h2>
<h3>Vagrantfile</h3>
<p>This is a default generic Vagrant file which starts a <code>m1.tiny</code> flavor image of Ubuntu Utopic. It requires that you already have added your ssh key to OpenStack. Please add your ssh key with the name <code>$USER_ssh_key</code>. </p>
<div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;vagrant-openstack-plugin&#39;</span>

<span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;dummy&quot;</span>
  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;/vagrant&quot;</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="s2">&quot;rsync&quot;</span><span class="p">,</span> <span class="n">rsync__exclude</span><span class="p">:</span> <span class="s2">&quot;.git/&quot;</span>

  <span class="c1"># Make sure the private key from the key pair is provided</span>
  <span class="n">config</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">private_key_path</span> <span class="o">=</span> <span class="s2">&quot;~/.ssh/id_rsa&quot;</span>

  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:openstack</span> <span class="k">do</span> <span class="o">|</span><span class="n">os</span><span class="o">|</span>
    <span class="n">os</span><span class="o">.</span><span class="n">username</span>     <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;OS_USERNAME&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">api_key</span>      <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;OS_PASSWORD&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">flavor</span>       <span class="o">=</span> <span class="sr">/m1.tiny/</span>
    <span class="n">os</span><span class="o">.</span><span class="n">image</span>        <span class="o">=</span> <span class="s2">&quot;Ubuntu CI utopic 2014-09-18&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">endpoint</span>     <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;OS_AUTH_URL&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/tokens&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">keypair_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;OS_USERNAME&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">_ssh_key&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">ssh_username</span> <span class="o">=</span> <span class="s2">&quot;ubuntu&quot;</span>

    <span class="c1"># The tenant have two networks, so need to specify at least one</span>
    <span class="n">os</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="s2">&quot;vagrant&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">floating_ip</span>        <span class="o">=</span> <span class="ss">:auto</span> 
    <span class="n">os</span><span class="o">.</span><span class="n">floating_ip_pool</span>   <span class="o">=</span> <span class="s2">&quot;public&quot;</span>
  <span class="k">end</span>

  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">path</span><span class="p">:</span> <span class="s2">&quot;bootstrap.sh&quot;</span>

  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="o">&lt;&lt;-</span><span class="no">SCRIPT</span>
<span class="sh">    # Set your country code here to get a local repositroy</span>
<span class="sh">    CN=&quot;no&quot;</span>
<span class="sh">    grep -q repo.met.no /etc/apt/sources.list || sed -i~ &quot;s#nova.clouds.archive.ubuntu.com#$CN.archive.ubuntu.com#g&quot; /etc/apt/sources.list</span>
<span class="sh">    apt-get update</span>
<span class="no">  SCRIPT</span>

  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="s2">&quot;myvm&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
  <span class="k">end</span>
<span class="k">end</span> 
</pre></div>


<h3>bootstrap.sh</h3>
<p>Create your custom bootstrap file.</p>
<div class="highlight"><pre><span class="c">#!/bin/bash</span>

<span class="c"># Your aditional bootstrap here...</span>
</pre></div>


<h2>Running Vagrant</h2>
<p>Remember to source your OpenStack RC file before you run Vagrant up. You need to do that in each shell windows you are going to run Vagrant in.</p>
<div class="highlight"><pre><span class="nb">source</span> ~/<span class="nv">$USER</span>-openrc.sh
vagrant up
</pre></div>


<h6>vim: set syn=markdown spell spl=en:</h6>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>
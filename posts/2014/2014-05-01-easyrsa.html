<!DOCTYPE html>
<html lang="en">
<head>
          <title>> /dev/null > 2>&1</title>
        <meta charset="utf-8" />
        <link href="http://blog.heimsbakk.net/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="> /dev/null > 2>&1 Full Atom Feed" />
        <link href="http://blog.heimsbakk.net/feeds/blog.atom.xml" type="application/atom+xml" rel="alternate" title="> /dev/null > 2>&1 Categories Atom Feed" />



    <meta name="tags" contents="howto" />
    <meta name="tags" contents="tomato" />
    <meta name="tags" contents="network" />
    <meta name="tags" contents="openvpn" />
    <meta name="tags" contents="security" />
    <meta name="tags" contents="vpn" />

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://blog.heimsbakk.net/">> /dev/null > 2>&1 <strong></strong></a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li><a href="/index.html">home</a></li>
            <li><a href="#">|</a></li>
              <li class="active"><a href="http://blog.heimsbakk.net/category/blog.html">blog</a></li>
              <li><a href="http://blog.heimsbakk.net/category/uris.html">uris</a></li>
        </ul></nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="http://blog.heimsbakk.net/posts/2014/2014-05-01-easyrsa.html" rel="bookmark"
         title="Permalink to Configuring OpenVPN server on RTN66U">Configuring OpenVPN server on RTN66U</a></h2>
 
  </header>
  <footer class="post-info">
    <abbr class="published" title="2014-05-01T00:00:00">
      to. 01 mai 2014
    </abbr>
    <address class="vcard author">
      By           <a class="url fn" href="http://blog.heimsbakk.net/author/arnulf.html">arnulf</a>
    </address>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <p>The router firmware Tomato, see previous post <a href="2014-04-17-tomato">RT-N66u with Tomato by Shibby firmware</a>, can act as an <a href="https://en.wikipedia.org/wiki/OpenVPN" title="OpenVPN">OpenVPN</a> server.</p>
<p>Using open <a href="https://en.wikipedia.org/wiki/Wifi" title="Wi-Fi">Wi-Fi</a> access points can be very useful and necessary, but it is inherently insecure. Using the router as an <a href="https://en.wikipedia.org/wiki/OpenVPN" title="OpenVPN">OpenVPN</a> server can increase your privacy and security when you are on the go. By creating an encrypted <a href="https://en.wikipedia.org/wiki/Vpn" title="Virtual Private Network">VPN</a> connection back home to the router, you don't only get protection from nosy eavesdroppers but you get access to all your equipment behind the router at home as well.</p>
<p>For <a href="https://en.wikipedia.org/wiki/OpenVPN" title="OpenVPN">OpenVPN</a> to work we need to create our own <a href="https://en.wikipedia.org/wiki/Certificate_authority" title="Certificate Authority">CA</a> for signing both server, the router, and optionally client certificates. This notes will only show how to create a server certificate and configure the router with user name and password authentication.</p>
<h2>Preparations, create CA</h2>
<p>Install necessary software. Although haveged, is not required, see <a href="2014-04-29-haveged">Better entropy with haveged</a>.</p>
<div class="highlight"><pre>sudo apt-get install easy-rsa haveged
</pre></div>


<p>Create a work directory for <a href="https://en.wikipedia.org/wiki/Certificate_authority" title="Certificate Authority">OpenVPN</a>. Take care to protect this directory and the files under it. </p>
<div class="highlight"><pre><span class="n">make</span><span class="o">-</span><span class="n">cadir</span> <span class="err">«</span><span class="n">yourdomain</span><span class="err">»</span>
</pre></div>


<p>Enter your <a href="https://en.wikipedia.org/wiki/Certificate_authority" title="Certificate Authority">CA</a> directory.</p>
<div class="highlight"><pre><span class="nb">cd</span> «yourdomain»
</pre></div>


<p>Edit the <code>vars</code> file and change the following variables to something more sensible for you.</p>
<div class="highlight"><pre><span class="nb">export </span><span class="nv">KEY_COUNTRY</span><span class="o">=</span><span class="s2">&quot;US&quot;</span>
<span class="nb">export </span><span class="nv">KEY_PROVINCE</span><span class="o">=</span><span class="s2">&quot;CA&quot;</span>
<span class="nb">export </span><span class="nv">KEY_CITY</span><span class="o">=</span><span class="s2">&quot;SanFrancisco&quot;</span>
<span class="nb">export </span><span class="nv">KEY_ORG</span><span class="o">=</span><span class="s2">&quot;Funston-Fort&quot;</span>
<span class="nb">export </span><span class="nv">KEY_EMAIL</span><span class="o">=</span><span class="s2">&quot;me@myhost.mydomain&quot;</span>
</pre></div>


<p>Source the variables into current bash session.</p>
<div class="highlight"><pre><span class="nb">source</span> ./vars
</pre></div>


<p>Do a initial clean.</p>
<div class="highlight"><pre><span class="p">.</span><span class="o">/</span><span class="n">clean</span><span class="o">-</span><span class="n">all</span> 
</pre></div>


<p>Create your <a href="https://en.wikipedia.org/wiki/Certificate_authority" title="Certificate Authority">CA</a> public and private key.</p>
<div class="highlight"><pre><span class="p">.</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">ca</span>
</pre></div>


<p>Generate your <a href="https://en.wikipedia.org/wiki/Diffie-Helmann" title="Diffie–Hellman key exchange">Diffie–Hellman</a> parameters.</p>
<div class="highlight"><pre><span class="p">.</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">dh</span>
</pre></div>


<p>Create your routers public and private key.</p>
<div class="highlight"><pre><span class="p">.</span><span class="o">/</span><span class="n">build</span><span class="o">-</span><span class="n">key</span><span class="o">-</span><span class="n">server</span> <span class="err">«</span><span class="n">yourrouter</span><span class="err">»</span>
</pre></div>


<p>Listing of folder <code>keys</code> should look something like this now.</p>
<div class="highlight"><pre><span class="n">ca</span><span class="p">.</span><span class="n">crt</span>  <span class="n">dh2048</span><span class="p">.</span><span class="n">pem</span>  <span class="n">serial</span>            <span class="err">«</span><span class="n">yourrouter</span><span class="err">»</span><span class="p">.</span><span class="n">csr</span>
<span class="n">ca</span><span class="p">.</span><span class="n">key</span>  <span class="n">index</span><span class="p">.</span><span class="n">txt</span>   <span class="err">«</span><span class="n">yourrouter</span><span class="err">»</span><span class="p">.</span><span class="n">crt</span>  <span class="err">«</span><span class="n">yourrouter</span><span class="err">»</span><span class="p">.</span><span class="n">key</span>
</pre></div>


<p>Now we are ready for configureing the <a href="https://en.wikipedia.org/wiki/OpenVPN" title="OpenVPN">OpenVPN</a> server in the router running <a href="http://tomato.groov.pl">Tomato by Shibby</a>.</p>
<h2>Configuring OpenVPN in Tomato</h2>
<ol>
<li>Log into the rouers admin interface.</li>
<li>Go to the menu <strong>VPN Tunneling → OpenVPN Server</strong>.</li>
<li>Select <strong>Server 1</strong>.</li>
<li>Leave the <strong>Basic</strong> tab with the defaults.</li>
<li>In the <strong>Advanced</strong> tab.  <ol>
<li>Check <strong>Allow User/Pass Auth</strong></li>
<li>Check <strong>Allow Only User/Pass(Without cert)</strong></li>
<li>Create users and set corresponding passwords.</li>
</ol>
</li>
<li>Go to the <strong>Key</strong> tab.<ol>
<li>Paste content of <code>ca.crt</code> into <strong>Certificate Authority</strong>.</li>
<li>Paste content of <code>«yourrouter».crt</code> into <strong>Server Certificate</strong>.</li>
<li>Paste content of <code>«yourrouter».key</code> into <strong>Server Key</strong>.</li>
<li>Paste content of <code>dh2048.pem</code> into <strong>Diffie Hellman parameters</strong>- </li>
</ol>
</li>
<li>Scroll to bottom of page and <strong>Save</strong>.</li>
<li>Press <strong>Start Now</strong>.</li>
</ol>
<p>That's it. Change listening port under <strong>Basic</strong> as needed. If you use port <code>80</code> or <code>443</code> and protocol <code>TCP</code> you will be able to connect through the most restrictive open access points. Be aware that some home <a href="https://en.wikipedia.org/wiki/Internet_Service_Provider" title="Internet Servicev Provider">ISP</a>s tend to block common port as <code>80</code>.</p>
<h2>Clients</h2>
<h3>Network Manager</h3>
<p>Now you can configure <a href="https://en.wikipedia.org/wiki/OpenVPN" title="OpenVPN">OpenVPN</a> on your computer. Remember to install the correct plugin, <code>network-manager-openvpn</code>.</p>
<div class="highlight"><pre>sudo apt-get install network-manager-openvpn
</pre></div>


<h3>Android</h3>
<p>Easy to use <a href="https://en.wikipedia.org/wiki/OpenVPN" title="OpenVPN">OpenVPN</a> client for Android is <a href="https://play.google.com/store/apps/details?id=de.blinkt.openvpn">OpenVPN for Android</a>.</p>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>